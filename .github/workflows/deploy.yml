name: CD - Deploy to Production

# è§¦å‘æ¡ä»¶ï¼šåˆ›å»º tagï¼ˆç‰ˆæœ¬å‘å¸ƒï¼‰
on:
  push:
    tags:
      - "v*.*.*"

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ~/1611sys

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆä»¥é˜²éœ€è¦å›æ»šï¼‰
            echo "ğŸ“¦ å¤‡ä»½å½“å‰éƒ¨ç½²..."
            BACKUP_TAG="backup-$(date +%Y%m%d-%H%M%S)"
            git tag $BACKUP_TAG || true

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "â¬‡ï¸ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch --all --tags
            git checkout ${{ steps.version.outputs.version }}

            # å¤‡ä»½æ•°æ®åº“
            echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
            ./scripts/backup-db.sh || echo "âš ï¸ æ•°æ®åº“å¤‡ä»½å¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²..."

            # åœæ­¢æœåŠ¡
            echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
            docker compose down

            # æ„å»ºæ–°é•œåƒ
            echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
            docker compose build

            # å¯åŠ¨æœåŠ¡
            echo "â–¶ï¸ å¯åŠ¨æœåŠ¡..."
            docker compose up -d

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10

            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
            for i in {1..30}; do
              if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
                echo "ğŸ“‹ æŸ¥çœ‹æ—¥å¿—:"
                docker compose logs --tail=50 backend
                exit 1
              fi
              echo "ç­‰å¾…ä¸­... ($i/30)"
              sleep 2
            done

            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„ Docker é•œåƒ..."
            docker image prune -f || true

            echo "âœ¨ éƒ¨ç½²å®Œæˆï¼ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
            echo "ğŸ“Š å½“å‰è¿è¡Œçš„å®¹å™¨:"
            docker compose ps

      - name: Notify deployment result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          fi
