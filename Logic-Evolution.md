# 1611 值日系统：排班逻辑进化史 (v1.0 - v4.5)

本文档旨在记录 1611 值日系统在开发过程中，针对人员变动、公平性、灵活性及中国调休制度等现实挑战，进行的五次重大逻辑版本迭代。

---

## 📅 版本演变概览

### **v1.0：简单静态快照 (Snapshot Era)**

- **逻辑**：系统在每周一凌晨根据当时员工列表的“物理索引（Index）”抓取 N 个人，存入数据库。
- **解决问题**：实现了最基础的自动化排班，不再需要人工点名。
- **局限性 (痛点)**：
  - **“刻舟求剑”**：一旦排班表生成，中间如果有新入职或离职，当周名单完全不更新。
  - **顺序崩溃**：如果删除中间的一名员工，后面的索引全部错位，导致下周排班出现重复或漏排。

---

### **v2.0：ID 锚点追踪 (The "Anchor" Era)**

- **核心改进**：引入 **“末位 ID 锚点”** 机制。不再记忆“排在第 3 名的人”，而是记忆“上周值日的最后一个人是谁（用 ID 记录）”。
- **解决问题**：彻底解决了**动态人员增删**导致的排班断裂。
  - 即使人员顺序乱了，系统也会在名单里找到上周那个人，然后顺着他的下一位开始排。
  - 满足了“绝对公平”：每个人在该轮到他的时候绝对跑不掉。
- **残留痛点**：数据库里存的依然是人员 ID 的“快照”。如果管理员在周三调整了排班顺序，由于本周快照已生成，变更要到下周才生效。

---

### **v3.0：免战牌机制 (The "Exemption" Era)**

- **核心改进**：新增 `isActive` 状态位（免战牌）。
- **解决问题**：解决了**临时出差/请假**的痛点。
  - 不需要删除员工，只需关掉开关，系统在生成名单时会自动跳过该员工。
- **逻辑冲突**：引入了“手动调整（isManual）”标志位。如果管理员手动调整了人数，系统会通过 `isManual: true` 锁定名单以示尊重。但这导致了一个新尴尬：如果你手动锁定了名单，之后再去改某个人的“免战”状态，首页名单依然纹丝不动（因为被手动标记锁死了）。

---

### **v4.0：全时动态直播 (The "Live Broadcast" Era) 🏆**

- **逻辑飞跃**：重新定义“手动模式”，将 **“名单锁定”** 降级为 **“人数锁定”**。
- **核心哲学**：**人数你说了算，人选系统实时算。**
- **具体表现**：
  1.  **动态重算**：每次打开首页，后台都会拿当前存储的 `dutyCount`（管理员设定的 2/3/4 人），结合最新的员工活跃状态和顺序，实时算出最优候选人。
  2.  **补位自愈**：如果你手动排了 4 个人，结果其中 3 个突然出差（设为免战），系统会自动抓取顺延后的后面 3 位活跃者补位，确保“ 4 人值日”的行政指令始终执行。
  3.  **瞬间归队**：当一个员工从“免战”恢复为“正常”时，只要他的顺位够前，他会立刻出现在当周名单上，给管理者最实时的反馈。

---

### **v4.5：节假日自适应 (Holiday Awareness) 🇨🇳**

- **逻辑飞跃**：引入 **“本周最后一个工作日 (Last Working Day)”** 概念，适配中国调休。
- **核心改进**：
  1.  **动态识别调休**：集成节假日 API，自动识别法定节假日（提前）和补班周六日（顺延）。
  2.  **智能通知调度**：提醒邮件不再死扣周五 17:00，而是自动对齐到该周的“放假前夕”发送。
  3.  **UI 实时对齐**：值日页面高亮展示计算后的真实值日日期，彻底消除员工对“放假那天到底谁值日”的疑虑。

---

## 🧠 总结与启示

从 v1.0 到 v4.0 的进化，本质上是从 **“面向静态数据编程”** 转向 **“面向动态状态编程”**。

- **技术层面**：通过 ID 锚点保证了长周期的**公平性**。
- **产品层面**：通过实时补位保证了短周期的**灵活性**。
- **体验层面**：让后台的操作（改状态、调顺序）在首页有“即时发生”的快感。

> [!TIP] > **复盘建议**：日后若要增加“多校区排班”或“多工种排班”，应继续沿用 v4.0 的**人数锁定+人选动态**原则，避免再次陷入死快照的维护陷阱。

---

_归档日期：2026-01-17_
_技术架构：Antigravity (Google Deepmind)_
