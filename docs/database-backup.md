# æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬ç³»ç»Ÿæä¾›äº†è‡ªåŠ¨åŒ–çš„æ•°æ®åº“å¤‡ä»½å’Œæ¢å¤æ–¹æ¡ˆï¼Œç¡®ä¿æ•°æ®å®‰å…¨ã€‚

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- âœ… æ¯å¤©å‡Œæ™¨ 2:00 è‡ªåŠ¨å¤‡ä»½
- âœ… å¤‡ä»½æ–‡ä»¶è‡ªåŠ¨å‹ç¼©
- âœ… è‡ªåŠ¨æ¸…ç† 7 å¤©å‰çš„æ—§å¤‡ä»½
- âœ… ä¸€é”®æ¢å¤è„šæœ¬
- âœ… å¤‡ä»½æ—¥å¿—è®°å½•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®è‡ªåŠ¨å¤‡ä»½

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
cd ~/1611sys
chmod +x scripts/*.sh
./scripts/setup-cron.sh
```

è¿™å°†é…ç½®æ¯å¤©å‡Œæ™¨ 2:00 è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“ã€‚

### 2. æ‰‹åŠ¨å¤‡ä»½

å¦‚æœéœ€è¦ç«‹å³å¤‡ä»½ï¼š

```bash
cd ~/1611sys
./scripts/backup-db.sh
```

### 3. æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶

```bash
ls -lh backups/
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
backup_duty_system_20260123_020000.sql.gz  2.3M
backup_duty_system_20260124_020000.sql.gz  2.4M
backup_duty_system_20260125_020000.sql.gz  2.5M
```

---

## ğŸ”„ æ¢å¤æ•°æ®åº“

### æ–¹å¼ 1ï¼šä»æœ€æ–°å¤‡ä»½æ¢å¤

```bash
cd ~/1611sys

# æŸ¥çœ‹å¯ç”¨å¤‡ä»½
ls -lt backups/

# æ¢å¤ï¼ˆæ›¿æ¢ä¸ºå®é™…æ–‡ä»¶åï¼‰
./scripts/restore-db.sh backups/backup_duty_system_20260125_020000.sql.gz
```

### æ–¹å¼ 2ï¼šä»æŒ‡å®šå¤‡ä»½æ¢å¤

```bash
# æ¢å¤åˆ°ç‰¹å®šæ—¶é—´ç‚¹
./scripts/restore-db.sh backups/backup_duty_system_20260123_020000.sql.gz
```

**âš ï¸ è­¦å‘Š**ï¼šæ¢å¤æ“ä½œä¼šè¦†ç›–å½“å‰æ•°æ®åº“ï¼Œè¯·è°¨æ…æ“ä½œï¼

---

## ğŸ“Š ç›‘æ§å¤‡ä»½çŠ¶æ€

### æŸ¥çœ‹å¤‡ä»½æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹å¤‡ä»½æ—¥å¿—
tail -f ~/1611sys/logs/backup.log

# æŸ¥çœ‹æœ€è¿‘ 50 è¡Œ
tail -n 50 ~/1611sys/logs/backup.log
```

### æŸ¥çœ‹å®šæ—¶ä»»åŠ¡

```bash
# æŸ¥çœ‹å½“å‰é…ç½®çš„å®šæ—¶ä»»åŠ¡
crontab -l

# è¾“å‡ºç¤ºä¾‹ï¼š
# 0 2 * * * cd /root/1611sys && /root/1611sys/scripts/backup-db.sh >> /root/1611sys/logs/backup.log 2>&1
```

### æ£€æŸ¥å¤‡ä»½æ˜¯å¦æ­£å¸¸è¿è¡Œ

```bash
# æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡å¤‡ä»½æ—¶é—´
ls -lt ~/1611sys/backups/ | head -2

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å¤§å°ï¼ˆåº”è¯¥ > 0ï¼‰
du -h ~/1611sys/backups/*.gz
```

---

## ğŸ› ï¸ é«˜çº§é…ç½®

### è‡ªå®šä¹‰å¤‡ä»½ä¿ç•™å¤©æ•°

ç¼–è¾‘ `scripts/backup-db.sh`ï¼Œä¿®æ”¹ `KEEP_DAYS` å˜é‡ï¼š

```bash
# ä¿ç•™ 30 å¤©çš„å¤‡ä»½
KEEP_DAYS="${KEEP_DAYS:-30}"
```

æˆ–è€…åœ¨æ‰§è¡Œæ—¶æŒ‡å®šï¼š

```bash
KEEP_DAYS=30 ./scripts/backup-db.sh
```

### è‡ªå®šä¹‰å¤‡ä»½æ—¶é—´

```bash
# ç¼–è¾‘å®šæ—¶ä»»åŠ¡
crontab -e

# ä¿®æ”¹ä¸ºæ¯å¤©å‡Œæ™¨ 3:00 æ‰§è¡Œ
# 0 3 * * * cd /root/1611sys && ...
```

Cron æ—¶é—´æ ¼å¼è¯´æ˜ï¼š
```
åˆ† æ—¶ æ—¥ æœˆ å‘¨
0  2  *  *  *   # æ¯å¤©å‡Œæ™¨ 2:00
0  */6 * *  *   # æ¯ 6 å°æ—¶ä¸€æ¬¡
0  2  *  *  0   # æ¯å‘¨æ—¥å‡Œæ™¨ 2:00
```

### å¤‡ä»½åˆ°è¿œç¨‹æœåŠ¡å™¨

æ·»åŠ åˆ° `backup-db.sh` æœ«å°¾ï¼š

```bash
# ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼ˆéœ€è¦é…ç½® SSH å¯†é’¥ï¼‰
scp "$BACKUP_FILE_GZ" user@backup-server:/backups/
```

---

## âŒ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: å¤‡ä»½è„šæœ¬æ²¡æœ‰æ‰§è¡Œæƒé™

```bash
chmod +x scripts/backup-db.sh
chmod +x scripts/restore-db.sh
```

### é—®é¢˜ 2: Docker å®¹å™¨æœªè¿è¡Œ

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep duty-system-db

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨æœåŠ¡
docker compose up -d
```

### é—®é¢˜ 3: å¤‡ä»½æ–‡ä»¶ä¸ºç©ºæˆ–å¾ˆå°

æ£€æŸ¥æ•°æ®åº“è¿æ¥ï¼š
```bash
docker exec -it duty-system-db psql -U postgres -d duty_system -c "\dt"
```

### é—®é¢˜ 4: cron ä»»åŠ¡æœªæ‰§è¡Œ

```bash
# æ£€æŸ¥ cron æœåŠ¡çŠ¶æ€
sudo systemctl status cron   # Ubuntu/Debian
sudo systemctl status crond  # CentOS/RHEL

# å¯åŠ¨ cron æœåŠ¡
sudo systemctl start cron
```

### é—®é¢˜ 5: æ¢å¤å¤±è´¥

ç¡®ä¿ï¼š
1. æ•°æ®åº“å®¹å™¨æ­£åœ¨è¿è¡Œ
2. å¤‡ä»½æ–‡ä»¶å®Œæ•´æœªæŸå
3. æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. å®šæœŸæµ‹è¯•æ¢å¤

æ¯æœˆè‡³å°‘æµ‹è¯•ä¸€æ¬¡æ¢å¤æµç¨‹ï¼Œç¡®ä¿å¤‡ä»½å¯ç”¨ï¼š

```bash
# åœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•æ¢å¤
./scripts/restore-db.sh backups/backup_duty_system_latest.sql.gz
```

### 2. ç›‘æ§å¤‡ä»½ç©ºé—´

```bash
# æ£€æŸ¥å¤‡ä»½ç›®å½•å ç”¨ç©ºé—´
du -sh backups/

# æ£€æŸ¥ç£ç›˜å‰©ä½™ç©ºé—´
df -h
```

### 3. é‡è¦æ“ä½œå‰æ‰‹åŠ¨å¤‡ä»½

åœ¨è¿›è¡Œé‡è¦æ›´æ–°æˆ–æ•°æ®è¿ç§»å‰ï¼š

```bash
./scripts/backup-db.sh
```

### 4. å¼‚åœ°å¤‡ä»½

å®šæœŸå°†å¤‡ä»½æ–‡ä»¶å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨æˆ–äº‘å­˜å‚¨ï¼š

```bash
# ä¸‹è½½åˆ°æœ¬åœ°
scp root@47.95.43.38:~/1611sys/backups/*.gz ./local-backups/

# æˆ–ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆç¤ºä¾‹ï¼šé˜¿é‡Œäº‘ OSSï¼‰
# ossutil cp backups/*.gz oss://your-bucket/backups/
```

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- å¤‡ä»½æ—¥å¿—: `logs/backup.log`
- Docker æ—¥å¿—: `docker compose logs postgres`
- ç³»ç»Ÿæ—¥å¿—: `/var/log/syslog` æˆ– `/var/log/cron`
