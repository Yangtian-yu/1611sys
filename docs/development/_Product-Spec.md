# 1611 值日系统 - 产品规格文档

**版本**：v1.0  
**创建日期**：2026-01-16  
**最后更新**：2026-01-16

---

## 项目概述

### 项目名称

1611 值日系统

### 目标用户

- **主要用户**：办公室管理员（1 人）
- **次要用户**：办公室员工（约 15 人）
- **使用场景**：办公室值日安排管理，每周五需要 2 人打扫卫生

### 核心价值主张

解决办公室值日安排混乱、员工容易忘记值日的问题，通过自动化排班和邮件提醒，确保值日工作有序进行。

### 核心痛点

1. 现有 Excel 表格管理方式，员工经常忘记查看
2. 人员变动时需要手动重新排班，容易出错
3. 缺乏自动提醒机制，依赖人工通知

---

## 功能需求

### P0 功能（必须有 - 第一版实现）

#### 1. 用户认证系统

- **管理员登录**
  - 系统部署时预设一个超级管理员账号
  - 使用用户名 + 密码登录
  - 密码需加密存储（bcrypt）
- **员工登录**

  - 使用管理员创建的账号登录
  - 用户名 + 密码认证
  - 无需注册功能

- **密码管理**
  - 用户可修改自己的密码
  - 管理员可重置任何用户的密码

#### 2. 员工管理（仅管理员）

- **创建员工账号**
  - 输入：用户名、初始密码、邮箱（QQ 邮箱）
  - 自动添加到值日轮换列表末尾
- **编辑员工信息**
  - 修改用户名、邮箱
  - 重置密码
- **调整员工顺序**
  - 拖拽排序功能
  - 调整后自动重新计算未来排班
- **删除员工**
  - 员工离职时删除账号
  - 自动从值日列表中移除
- **值日开关（免战牌） [NEW]**
  - 管理员可为每个员工设置“是否参与排班”开关
  - 用于处理出差、长期请假等情况，无需删除员工
  - 关闭开关后，系统自动排班时将跳过此人
  - 重新开启后，该员工按原有的 `orderIndex` 回到轮训队列

#### 3. 值日排班系统

- **自动排班逻辑**

  - 每周一早上自动生成本周值日安排
  - 轮流制：按员工列表顺序（orderIndex），每次取 N 人（N=2/3/4）
  - 轮训规则：
    - 每个员工在一个轮次中只打扫一次
    - 打扫后自动进入下一个轮次
    - 下周从本周最后一个值日人员的下一个开始
    - **自动跳过**：若顺位员工的“值日开关”为关闭状态，则自动跳过并选择下一位开启状态的员工
  - 示例（6 人：A B C D E F）：
    - 第 1 周（2 人）：A + B
    - 第 2 周（2 人）：C + D
    - 第 3 周（4 人大扫除）：E + F + A + B
    - 第 4 周（2 人）：C + D（从 B 的下一个开始）
    - 第 5 周（2 人）：E + F
    - 第 6 周（2 人）：A + B（循环）

- **本周人数调整**

  - 管理员可调整本周值日人数（2/3/4 人）
  - 下拉框选择，系统自动按顺序选择对应数量的人
  - 调整后标记为手动调整（isManual: true）
  - 不支持手动选择具体人员，只能选择人数

- **员工排序管理**

  - 在员工管理页面，管理员可拖拽调整员工顺序
  - 员工顺序（orderIndex）决定值日轮流顺序
  - 调整顺序不影响本周排班，从下周生效

- **查看排班**

  - 所有用户可查看当前周值日人员
  - 仅显示本周值日的人（2-4 人），不显示所有员工
  - 仅显示本周，不显示未来周（因人员可能变动）

- **边界条件**

  - 员工数量 < 选择人数时：后台报错，返回错误提示
  - 没有员工时：显示"请先添加员工"
  - 员工被删除时：不影响本周，下周重新计算

#### 4. 节假日自适应（中国调休适配） [NEW - v4.5]

- **核心概念**：系统不再死板地锁定“每周五”，而是锁定“本周最后一个工作日”。
- **识别机制**：
  - 集成中国法定节假日数据（含调休）。
  - 自动识别“补班日”（如周六/周日因调休需上班）。
- **动态调整逻辑**：
  - **排班日期**：默认为本周最后一个工作日。
  - **触发时机**：若周五是法定节假日，排班通知将自动提前同步至周四（或该周最后一个工作日）。
  - **邮件发送**：定时任务将在识别出的“本周最后一个工作日”下午 17:00 准时触发。
- **示例**：

  - 正常周：周五下班前通知。
  - 国庆前夕（周五放假）：自动提前至周四下班前通知。
  - 调休周（周六补班）：通知时间依然维持在该周逻辑上的最后一个工作日。

- **发送时机**
  - 在“本周最后一个工作日”（通常为周五，若遇节假日则提前）下午 17:00 自动发送
- **通知对象**
  - 发送给所有员工（非仅值日人员）
- **邮件内容**

  - 可由管理员编辑的模板
  - 默认模板：

    ```
    【1611值日系统】本周值日通知

    本周值日人员：张三、李四

    值日时间：本周五下午
    请准时完成值日工作，谢谢配合！
    ```

- **技术实现**
  - 使用 SMTP 发送邮件
  - 支持 QQ 邮箱等常见邮箱服务

#### 5. 管理员功能面板

- **编辑邮件通知文案**
  - 富文本编辑器或纯文本
  - 支持变量：`{值日人员}`, `{日期}`
- **手动调整本周值日**
  - 临时修改本周值日人员
  - 可增加人数（2 人变 4 人）
  - 调整后自动更新下一轮排班

---

### P1 功能（重要 - 第二版实现）

#### 1. 历史记录查看

- 查看过去的值日记录
- 按周、按月筛选
- 导出为 Excel

#### 2. 数据统计

- 每人值日次数统计
- 值日完成率

#### 3. 手动触发邮件

- 管理员可手动发送邮件通知
- 用于测试或补发

---

### P2 功能（锦上添花 - 未来考虑）

#### 1. 值日打卡

- 值日人员完成后打卡确认
- 记录完成时间

#### 2. 暗色模式

- 支持浅色/深色主题切换

#### 3. 移动端适配

- 响应式设计，支持手机访问

---

## 用户故事

### 管理员

1. 作为管理员，我想要创建员工账号，以便新员工可以登录系统查看值日安排
2. 作为管理员，我想要调整员工顺序，以便在人员变动时快速更新排班
3. 作为管理员，我想要手动调整本周值日人员，以便应对临时情况（如员工请假）
4. 作为管理员，我想要编辑邮件通知文案，以便根据实际情况调整通知内容
5. 作为管理员，我想要重置员工密码，以便帮助忘记密码的员工

### 普通员工

1. 作为员工，我想要登录系统查看本周值日人员，以便知道谁负责打扫
2. 作为员工，我想要修改自己的密码，以便保护账号安全
3. 作为员工，我想要每周五收到邮件提醒，以便不会忘记值日安排

---

## 技术约束

### 技术栈

- **前端**：Vue 3 + Vite + TypeScript + Tailwind CSS + Element Plus
- **后端**：Nest.js + Prisma + PostgreSQL
- **部署**：云服务器（已购买）
- **邮件服务**：Nodemailer + SMTP

### 性能要求

- 页面加载时间 < 2 秒
- 支持 15 人同时在线
- 邮件发送成功率 > 95%

### 安全要求

- 密码使用 bcrypt 加密存储
- 使用 JWT 进行身份验证
- 防止 SQL 注入（使用 Prisma ORM）
- HTTPS 加密传输

### 兼容性要求

- 仅支持桌面端访问
- 浏览器：Chrome 90+, Edge 90+, Firefox 88+

---

## 数据库设计

### 核心表结构

#### users（用户表）

```sql
- id: UUID (主键)
- username: VARCHAR(50) (唯一)
- password: VARCHAR(255) (bcrypt 加密)
- email: VARCHAR(100)
- role: ENUM('admin', 'employee')
- order_index: INTEGER (值日顺序)
- is_active: BOOLEAN (值日开关，默认为 true)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

#### duty_schedules（值日排班表）

```sql
- id: UUID (主键)
- week_start_date: DATE (周一日期)
- duty_users: JSON (值日人员 ID 数组)
- is_manual: BOOLEAN (是否手动调整)
- created_at: TIMESTAMP
```

#### email_templates（邮件模板表）

```sql
- id: UUID (主键)
- template_content: TEXT
- updated_at: TIMESTAMP
```

---

## 验收标准

### 功能验收

- [ ] 管理员可成功创建员工账号
- [ ] 员工可使用账号密码登录
- [ ] 系统每周一自动生成本周值日安排
- [ ] 每周五下午 4 点自动发送邮件给所有员工
- [ ] 管理员可拖拽调整员工顺序，排班自动更新
- [ ] 管理员可手动调整本周值日人员（支持 2 人变 4 人）
- [ ] 用户可修改自己的密码
- [ ] 管理员可重置任何用户的密码

### 性能验收

- [ ] 页面加载时间 < 2 秒
- [ ] 邮件发送延迟 < 10 秒

### 安全验收

- [ ] 密码在数据库中以加密形式存储
- [ ] 未登录用户无法访问系统功能
- [ ] 普通员工无法访问管理员功能

---

## 风险与备选方案

### 主要风险

#### 1. 邮件发送失败

- **风险**：QQ 邮箱 SMTP 可能被限流或拒绝
- **备选方案**：
  - 使用企业邮箱服务（如阿里云邮件推送）
  - 添加邮件发送失败重试机制
  - 在系统内显示"邮件发送失败"提示

#### 2. 排班逻辑复杂度

- **风险**：频繁的人员调整可能导致排班混乱
- **备选方案**：
  - 添加"排班预览"功能，调整前先预览
  - 记录每次调整的历史，支持回滚

#### 3. 定时任务可靠性

- **风险**：服务器重启可能导致定时任务失效
- **备选方案**：
  - 使用 cron 或系统级定时任务
  - 添加任务执行日志，便于排查

---

## 开发计划

### 第一阶段（核心功能）

- 用户认证系统
- 员工管理
- 基础排班逻辑

### 第二阶段（自动化）

- 自动排班生成
- 邮件通知系统
- 定时任务

### 第三阶段（优化）

- 手动调整排班
- 邮件模板编辑
- 密码管理

---

## 附录

### 初始管理员账号

- 用户名：admin
- 初始密码：Admin@1611（首次登录后强制修改）

### 邮件发送配置

- SMTP 服务器：smtp.qq.com
- 端口：465（SSL）或 587（TLS）
- 需要在 QQ 邮箱设置中开启 SMTP 服务并获取授权码
