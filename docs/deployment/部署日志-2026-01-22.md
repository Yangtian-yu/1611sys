# 🚀 值班系统生产环境部署日志

**部署日期**：2026年1月22日
**部署人员**：Yangtianyu
**服务器 IP**：<YOUR_SERVER_IP>
**项目仓库**：https://github.com/Yangtian-yu/1611sys

---

## 📋 目录

1. [购买阿里云 ECS 服务器](#1-购买阿里云-ecs-服务器)
2. [服务器基础配置](#2-服务器基础配置)
3. [安装 Docker 环境](#3-安装-docker-环境)
4. [配置安全组和防火墙](#4-配置安全组和防火墙)
5. [准备项目代码](#5-准备项目代码)
6. [部署项目](#6-部署项目)
7. [遇到的问题和解决方案](#7-遇到的问题和解决方案)
8. [最终配置总结](#8-最终配置总结)

---

## 1. 购买阿里云 ECS 服务器

### 1.1 服务器配置

| 配置项 | 选择 | 说明 |
|--------|------|------|
| **实例规格** | 2核2GB (ecs.e-c1m1.large) | 经济型，99元/年 |
| **操作系统** | Ubuntu 24.04 LTS 64位 | 稳定且文档丰富 |
| **系统盘** | ESSD Entry 40GB | 够用 |
| **带宽** | 按固定带宽 3Mbps | 小型项目够用 |
| **地域** | 华北2（北京） | 国内访问速度快 |
| **付费模式** | 包年包月 1年 | 99元/年特惠 |

### 1.2 购买步骤

1. 访问阿里云控制台：https://ecs.console.aliyun.com/
2. 创建实例，选择上述配置
3. 设置 root 密码（已设置强密码）
4. 完成支付

### 1.3 获取服务器信息

- **公网 IP**：<YOUR_SERVER_IP>
- **实例 ID**：i-2ze0s0qqu8dhwy5sgssgZ
- **地域**：华北2（北京）

---

## 2. 服务器基础配置

### 2.1 连接到服务器

**工具**：FinalShell（Mac 可视化 SSH 工具）

**连接信息**：
- 主机：<YOUR_SERVER_IP>
- 端口：22
- 用户名：root
- 密码：（已设置）

### 2.2 更新系统

```bash
# 更新包列表
apt update

# 升级已安装的包
apt upgrade -y
```

**执行时间**：约 2-3 分钟

---

## 3. 安装 Docker 环境

### 3.1 使用阿里云镜像源安装

由于国内访问 Docker 官方源较慢，使用阿里云镜像源：

```bash
# 使用官方便捷脚本（阿里云镜像）
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
```

**执行时间**：约 3-5 分钟

### 3.2 验证安装

```bash
docker --version
# 输出：Docker version 29.1.5

docker compose version
# 输出：Docker Compose version v2.x.x
```

### 3.3 配置 Docker 镜像加速

创建 Docker 配置文件，使用国内镜像源：

```bash
# 创建配置目录
mkdir -p /etc/docker

# 配置镜像加速
cat > /etc/docker/daemon.json <<'EOF'
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://dockerproxy.com",
    "https://mirror.baidubce.com",
    "https://docker.nju.edu.cn"
  ]
}
EOF

# 重启 Docker 服务
systemctl daemon-reload
systemctl restart docker

# 验证配置
docker info | grep -A 5 "Registry Mirrors"
```

**原因**：国内访问 Docker Hub 很慢，配置镜像源可大幅提升下载速度

---

## 4. 配置安全组和防火墙

### 4.1 阿里云安全组配置

在阿里云控制台配置安全组规则：

**路径**：云服务器 ECS → 安全组 → 配置规则 → 入方向

添加以下规则：

| 端口范围 | 协议 | 授权对象 | 说明 |
|---------|------|----------|------|
| 22/22 | TCP | 0.0.0.0/0 | SSH 登录 |
| 80/80 | TCP | 0.0.0.0/0 | HTTP 访问 |
| 443/443 | TCP | 0.0.0.0/0 | HTTPS 访问（预留） |

### 4.2 服务器防火墙配置

Ubuntu 使用 UFW 防火墙：

```bash
# 启用 UFW
ufw enable

# 允许 SSH（重要！）
ufw allow 22/tcp

# 允许 HTTP 和 HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# 查看状态
ufw status
```

---

## 5. 准备项目代码

### 5.1 Git 仓库管理

#### 问题：敏感文件泄露

项目中的 `.env` 文件包含数据库密码、JWT 密钥、QQ 邮箱授权码等敏感信息，已经被提交到 Git。

#### 解决方案

**在本地执行**：

```bash
cd /Users/yangtianyu/Desktop/学习文件夹/1611sys

# 1. 创建 .gitignore 文件
cat > .gitignore << 'EOF'
# 环境变量文件（包含敏感信息）
.env
.env.local
.env.production
.env.*.local

# 依赖目录
node_modules/
backend/node_modules/
frontend/node_modules/

# 构建输出
dist/
build/
backend/dist/
frontend/dist/

# 日志文件
*.log

# 操作系统文件
.DS_Store

# IDE 配置
.vscode/
.idea/

# 数据库文件
*.sql
EOF

# 2. 从 Git 中删除敏感文件（保留本地）
git rm --cached .env .env.local .env.production

# 3. 提交更改
git add .gitignore
git commit -m "Remove sensitive env files from git and add .gitignore"

# 4. 推送到 GitHub
git push origin main
```

**重要**：虽然从 Git 中删除了，但历史记录中仍存在，需要：
- ✅ 修改 QQ 邮箱授权码（已完成）
  - 旧授权码：`<YOUR_EMAIL_PASSWORD>`（已删除）
  - 新授权码：`<YOUR_EMAIL_PASSWORD>`
- ✅ 修改数据库密码为强密码

### 5.2 公开仓库

将私有仓库改为公开：
- **原因**：方便部署，不需要 Token 或 SSH 密钥
- **路径**：GitHub 仓库 → Settings → Danger Zone → Change visibility → Make public

### 5.3 克隆代码到服务器

```bash
cd /root
git clone https://github.com/Yangtian-yu/1611sys.git
cd 1611sys
```

---

## 6. 部署项目

### 6.1 创建生产环境配置文件

在服务器上创建 `.env` 文件：

```bash
cat > .env << 'EOF'
# 生产环境配置
NODE_ENV=production

# 数据库配置
POSTGRES_USER=postgres
POSTGRES_PASSWORD=ProdDB@2026!Strong#Pass
POSTGRES_DB=duty_system

# 数据库连接字符串
DATABASE_URL=postgresql://postgres:ProdDB@2026!Strong#Pass@postgres:5432/duty_system

# JWT 密钥
JWT_SECRET=<YOUR_JWT_SECRET>

# 后端端口
PORT=3000

# 邮件服务配置
MAIL_USER=<YOUR_EMAIL>
MAIL_PASS=<YOUR_EMAIL_PASSWORD>

# 首次部署
DB_SEED=true
EOF
```

**注意**：
- 使用强密码
- 邮箱授权码使用新生成的
- `DB_SEED=true` 用于首次部署生成测试数据

### 6.2 修改前端 API 地址

```bash
nano frontend/Dockerfile
```

修改第 20 行左右的环境变量：

```dockerfile
ENV VITE_API_BASE_URL=http://<YOUR_SERVER_IP>/api
```

### 6.3 修改 Dockerfile 使用国内镜像源

#### 问题：npm 下载依赖超时

构建过程中卡在 `RUN npm install -g pnpm`，国内访问 npm 官方源很慢。

#### 解决方案

修改 `backend/Dockerfile` 和 `frontend/Dockerfile`，添加国内镜像源配置。

**后端 Dockerfile**：

```dockerfile
# 构建阶段
FROM node:20-slim as builder

# 配置国内镜像源
RUN npm config set registry https://registry.npmmirror.com && \
    npm install -g pnpm && \
    pnpm config set registry https://registry.npmmirror.com

WORKDIR /app

# 复制依赖配置文件
COPY package.json pnpm-lock.yaml ./
COPY prisma ./prisma/

# 安装依赖
RUN pnpm install --frozen-lockfile

# 复制源代码
COPY . .

# 生成 Prisma Client
RUN pnpm prisma generate

# 构建项目
RUN pnpm build

# 生产阶段
FROM node:20-slim

# 安装运行时依赖
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# 配置国内镜像源
RUN npm config set registry https://registry.npmmirror.com && \
    npm install -g pnpm && \
    pnpm config set registry https://registry.npmmirror.com

WORKDIR /app

# 从构建阶段复制文件
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/package.json ./

EXPOSE 3000

CMD ["sh", "-c", "pnpm prisma migrate deploy && node dist/main"]
```

**前端 Dockerfile**：

```dockerfile
# 构建阶段
FROM node:20-alpine as builder

# 配置国内镜像源
RUN npm config set registry https://registry.npmmirror.com && \
    npm install -g pnpm && \
    pnpm config set registry https://registry.npmmirror.com

WORKDIR /app

# 复制依赖文件
COPY package.json pnpm-lock.yaml ./

# 安装依赖
RUN pnpm install --frozen-lockfile

# 复制源代码
COPY . .

# 设置环境变量（生产环境 API 地址）
ENV VITE_API_BASE_URL=http://<YOUR_SERVER_IP>/api

# 构建
RUN pnpm build

# 生产阶段
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 6.4 启动项目

```bash
docker compose up -d --build
```

**参数说明**：
- `up`：启动服务
- `-d`：后台运行
- `--build`：重新构建镜像

**预计时间**：
- 第一次构建：5-8 分钟（配置镜像源后）
- 后续更新：2-3 分钟

### 6.5 查看构建日志

```bash
docker compose logs -f
```

按 `Ctrl + C` 退出日志查看（不影响服务运行）

### 6.6 检查服务状态

```bash
docker compose ps
```

**成功标志**：3 个服务都是 `Up` 状态：
```
NAME                   STATUS
duty-system-db         Up
duty-system-backend    Up
duty-system-frontend   Up
```

---

## 7. 遇到的问题和解决方案

### 问题 1：环境变量未加载

**现象**：
```
WARN[0000] The "POSTGRES_PASSWORD" variable is not set. Defaulting to a blank string.
```

**原因**：`.env` 文件格式错误，多个变量写在同一行。

**错误格式**：
```bash
POSTGRES_USER=postgres POSTGRES_PASSWORD=xxx POSTGRES_DB=duty_system
```

**正确格式**：
```bash
POSTGRES_USER=postgres
POSTGRES_PASSWORD=xxx
POSTGRES_DB=duty_system
```

**解决方案**：重新创建 `.env` 文件，确保每个变量单独一行。

---

### 问题 2：Docker Hub 镜像下载超时

**现象**：
```
failed to resolve reference "docker.io/library/postgres:16-alpine": dial tcp 198.44.185.131:443: i/o timeout
```

**原因**：国内访问 Docker Hub 被限制或很慢。

**解决方案**：配置国内 Docker 镜像加速源。

```bash
cat > /etc/docker/daemon.json <<'EOF'
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://dockerproxy.com",
    "https://mirror.baidubce.com",
    "https://docker.nju.edu.cn"
  ]
}
EOF

systemctl daemon-reload
systemctl restart docker
```

---

### 问题 3：npm 安装依赖超时

**现象**：构建卡在 `RUN npm install -g pnpm`，超过 28 分钟无响应。

**原因**：国内访问 npm 官方源很慢或被墙。

**解决方案**：在 Dockerfile 中配置淘宝 npm 镜像源。

```dockerfile
RUN npm config set registry https://registry.npmmirror.com && \
    npm install -g pnpm && \
    pnpm config set registry https://registry.npmmirror.com
```

---

### 问题 4：后端 Dockerfile 构建失败

**现象**：
```
process "/bin/sh -c apt-get install -y libssl3" did not complete successfully: exit code: 100
```

**原因**：`libssl3` 包在某些 Debian 版本中不存在。

**解决方案**：将 `libssl3` 改为 `ca-certificates`。

```dockerfile
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \      # 改为 ca-certificates
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*
```

---

### 问题 5：敏感信息泄露到 Git

**现象**：`.env` 文件包含密码、密钥等敏感信息已提交到 GitHub。

**解决方案**：
1. 创建 `.gitignore` 忽略 `.env` 文件
2. 使用 `git rm --cached` 从 Git 中删除（保留本地文件）
3. 修改已泄露的密码和密钥
4. 提交并推送更改

---

### 问题 6：数据库连接字符串解析错误

**现象**：
```
Can't reach database server at `2026!Strong:5432`
```

**原因**：数据库密码 `ProdDB@2026!Strong#Pass` 包含 `@` 符号，导致 URL 解析错误。

在连接字符串 `postgresql://postgres:ProdDB@2026!Strong#Pass@postgres:5432/duty_system` 中，密码中的 `@` 被误认为是主机名分隔符。

**解决方案**：修改密码，避免使用特殊字符 `@`、`:` 、`/`。

```bash
# 修改为不含 @ 符号的密码
POSTGRES_PASSWORD=ProdDB_2026_Strong_Pass_9527
DATABASE_URL=postgresql://postgres:ProdDB_2026_Strong_Pass_9527@postgres:5432/duty_system
```

---

### 问题 7：数据库密码认证失败

**现象**：
```
Error: P1000: Authentication failed against database server at `postgres`,
the provided database credentials for `postgres` are not valid.
```

**原因**：数据库容器第一次启动时用旧密码初始化，密码已存储在 Docker volume 中。修改 `.env` 文件后，数据库容器内的密码没有更新。

**解决方案**：删除数据库卷，重新初始化。

```bash
docker compose down
docker volume rm 1611sys_postgres_data
docker compose up -d
```

---

### 问题 8：后端启动失败 - 找不到 main 模块

**现象**：
```
Error: Cannot find module '/app/dist/main'
```

**原因**：后端 Docker 镜像构建过程中，`dist` 目录没有正确生成或复制。

**解决方案**：
1. 检查构建阶段是否正确执行 `pnpm build`
2. 检查生产阶段是否正确复制 `COPY --from=builder /app/dist ./dist`
3. 重新构建镜像（不使用缓存）

```bash
docker compose down
docker rmi 1611sys-backend
docker compose build --no-cache backend
docker compose up -d
```

---

### 问题 9：无法访问 Debian 软件源

**现象**：
```
E: Failed to fetch http://deb.debian.org/debian/pool/main/...
E: Unable to connect to deb.debian.org:80
```

**原因**：国内访问 Debian 官方源很慢或被墙，导致 `apt-get install` 超时。

**解决方案**：在 Dockerfile 中配置国内 Debian 镜像源（阿里云）。

```dockerfile
# 在 apt-get 之前添加
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

# 然后执行 apt-get
RUN apt-get update && apt-get install -y ...
```

---

### 问题 10：数据库表未初始化

**现象**：
```
The table `public.users` does not exist in the current database
```

**原因**：Prisma 迁移未执行，数据库中没有创建表结构。

**解决方案**：使用 `db push` 创建表结构。

```bash
docker compose exec backend pnpm prisma db push
```

**注意**：
- 开发环境用 `prisma migrate dev`
- 生产环境首次部署用 `prisma db push`
- 后续更新用 `prisma migrate deploy`

---

### 问题 11：JWT 认证后用户 ID undefined 错误

**现象**：
登录成功，但修改员工、调整员工顺序、修改密码等操作全部报 500 错误。
```
Invalid `prisma.user.findUnique()` invocation:
{
  where: {
    id: undefined,  // ❌ 用户 ID 为 undefined
```

**原因**：代码中存在 3 个 bug（本地未完整测试所有功能，只测试了登录）：
1. **auth.controller.ts**：使用了 `req.user.userId` 但应该是 `req.user.id`
2. **user.controller.ts**：使用 `ParseIntPipe` 将 UUID 字符串转成整数，类型不匹配
3. **user.service.ts**：参数类型是 `number` 但数据库 ID 是 UUID 字符串

**解决方案**：

1. 修复 `backend/src/modules/auth/auth.controller.ts`：
```typescript
// 错误
return this.authService.changePassword(req.user.userId, changePasswordDto);

// 正确
return this.authService.changePassword(req.user.id, changePasswordDto);
```

2. 修复 `backend/src/modules/user/user.controller.ts`：
```typescript
// 错误 - 使用 ParseIntPipe
@Put(":id")
update(@Param("id", ParseIntPipe) id: number, @Body() updateUserDto: UpdateUserDto)

// 正确 - 移除 ParseIntPipe，使用 string
@Put(":id")
update(@Param("id") id: string, @Body() updateUserDto: UpdateUserDto)
```

3. 修复 `backend/src/modules/user/user.service.ts`：
```typescript
// 错误 - 参数是 number，还要 String(id) 转换
async update(id: number, updateUserDto: UpdateUserDto) {
  const user = await this.prisma.user.findUnique({
    where: { id: String(id) },
  });
}

// 正确 - 参数直接是 string
async update(id: string, updateUserDto: UpdateUserDto) {
  const user = await this.prisma.user.findUnique({
    where: { id },
  });
}
```

4. 修复 `backend/src/modules/user/dto/reorder-users.dto.ts`：
```typescript
// 错误
userIds: number[];

// 正确
userIds: string[];
```

**部署步骤**：
```bash
cd ~/1611sys
git pull origin main
docker compose down
docker compose build backend  # 只修改了代码，用缓存构建即可
docker compose up -d
```

**经验教训**：
- 本地开发时必须测试所有 CRUD 操作，不能只测试登录
- TypeScript 类型要和数据库 schema 保持一致（UUID 是 string 不是 number）
- 生产部署前应该有完整的功能测试清单

---

## 8. 最终配置总结

### 8.1 服务器配置

| 项目 | 配置 |
|------|------|
| **服务器** | 阿里云 ECS |
| **规格** | 2核2GB |
| **操作系统** | Ubuntu 24.04 LTS |
| **公网 IP** | <YOUR_SERVER_IP> |
| **费用** | 99元/年（续费同价） |

### 8.2 软件版本

| 软件 | 版本 |
|------|------|
| **Docker** | 29.1.5 |
| **Docker Compose** | v2.x.x |
| **Node.js** | 20 (容器内) |
| **PostgreSQL** | 16 (容器内) |
| **Nginx** | alpine (容器内) |

### 8.3 项目结构

```
/root/1611sys/
├── backend/              # 后端代码（NestJS）
├── frontend/             # 前端代码（Vue 3）
├── docker-compose.yml    # Docker Compose 配置
├── .env                  # 生产环境变量（不提交到 Git）
└── .gitignore           # Git 忽略文件配置
```

### 8.4 服务端口映射

| 服务 | 容器端口 | 主机端口 | 说明 |
|------|----------|----------|------|
| **Frontend** | 80 | 80 | Nginx 前端服务 |
| **Backend** | 3000 | 3000 | NestJS 后端 API |
| **Database** | 5432 | 5432 | PostgreSQL 数据库 |

### 8.5 访问地址

- **前端访问**：http://<YOUR_SERVER_IP>
- **后端 API**：http://<YOUR_SERVER_IP>/api

### 8.6 默认登录账号

（如果启用了种子数据 `DB_SEED=true`）

- **用户名**：admin
- **密码**：admin123

---

## 9. 日常维护命令

### 查看服务状态

```bash
cd /root/1611sys
docker compose ps
```

### 查看日志

```bash
# 查看所有服务日志
docker compose logs -f

# 查看特定服务日志
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f postgres
```

### 重启服务

```bash
# 重启所有服务
docker compose restart

# 重启特定服务
docker compose restart backend
```

### 更新项目

```bash
cd /root/1611sys

# 拉取最新代码
git pull

# 重新构建并启动
docker compose up -d --build
```

### 备份数据库

```bash
# 导出数据库
docker exec duty-system-db pg_dump -U postgres duty_system > backup_$(date +%Y%m%d).sql

# 恢复数据库
docker exec -i duty-system-db psql -U postgres duty_system < backup_20260122.sql
```

### 清理 Docker 资源

```bash
# 清理未使用的镜像和容器
docker system prune -a

# 清理未使用的卷
docker volume prune
```

---

## 10. 后续优化建议

### 10.1 配置域名和 HTTPS

当前使用 IP 访问，建议：
1. 购买域名
2. 配置 DNS 解析到服务器 IP
3. 使用 Let's Encrypt 免费 SSL 证书
4. 配置 Nginx HTTPS

### 10.2 配置 GitHub Actions 自动部署

实现推送代码自动部署：
1. 配置 GitHub Actions workflow
2. 在 GitHub Actions 构建 Docker 镜像
3. 推送到镜像仓库（阿里云）
4. 服务器自动拉取并更新

**优势**：
- 构建在 GitHub 服务器进行（2核7GB）
- 服务器只需下载镜像（30秒完成部署）
- 不占用服务器资源

### 10.3 监控和告警

建议添加：
- 服务器资源监控（CPU、内存、磁盘）
- 应用日志监控
- 错误告警（邮件/微信）

### 10.4 数据库定期备份

建议配置：
- 每天自动备份数据库
- 备份文件保留 7 天
- 定期测试恢复流程

---

## 11. 部署总结

### 11.1 部署时间线

| 阶段 | 耗时 | 说明 |
|------|------|------|
| **购买服务器** | 5 分钟 | 选择配置并支付 |
| **基础配置** | 10 分钟 | 连接、更新系统 |
| **安装 Docker** | 5 分钟 | 使用阿里云镜像 |
| **配置安全组** | 5 分钟 | 开放端口 |
| **准备代码** | 15 分钟 | Git 处理、克隆 |
| **首次部署** | 8 分钟 | 构建并启动（已优化） |
| **总计** | **约 50 分钟** | 首次完整部署 |

### 11.2 关键要点

✅ **成功要素**：
1. 选择国内镜像源（Docker、npm）
2. 正确配置环境变量（每行一个）
3. 配置安全组开放端口
4. 使用 Docker Compose 简化部署
5. 敏感信息不提交到 Git

⚠️ **注意事项**：
1. 定期备份数据库
2. 监控服务器资源使用
3. 及时更新系统和依赖
4. 关注安全漏洞公告

### 11.3 技术栈

**前端**：
- Vue 3 + Vite
- Element Plus
- Pinia
- TypeScript

**后端**：
- NestJS
- Prisma ORM
- PostgreSQL
- JWT 认证

**部署**：
- Docker + Docker Compose
- Nginx
- 阿里云 ECS

---

## 12. 参考资源

- **Docker 官方文档**：https://docs.docker.com/
- **阿里云 ECS 文档**：https://help.aliyun.com/product/25365.html
- **GitHub Actions 文档**：https://docs.github.com/en/actions
- **Let's Encrypt**：https://letsencrypt.org/
- **淘宝 npm 镜像**：https://npmmirror.com/

---

## 附录：完整配置文件

### backend/Dockerfile（最终版本）

```dockerfile
# 构建阶段
FROM node:20-slim as builder

# 配置 Debian 国内镜像源
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

# 配置 npm 国内镜像源
RUN npm config set registry https://registry.npmmirror.com && \
    npm install -g pnpm && \
    pnpm config set registry https://registry.npmmirror.com

WORKDIR /app

COPY package.json pnpm-lock.yaml ./
COPY prisma ./prisma/

RUN pnpm install --frozen-lockfile

COPY . .

RUN pnpm prisma generate

RUN pnpm build

# 生产阶段
FROM node:20-slim

# 配置 Debian 国内镜像源
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

# 安装运行时依赖
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# 配置 npm 国内镜像源
RUN npm config set registry https://registry.npmmirror.com && \
    npm install -g pnpm && \
    pnpm config set registry https://registry.npmmirror.com

WORKDIR /app

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/package.json ./

EXPOSE 3000

CMD ["sh", "-c", "pnpm prisma migrate deploy && node dist/main"]
```

### docker-compose.yml

（当前项目已有，无需修改）

### .env（生产环境）

```bash
NODE_ENV=production
POSTGRES_USER=postgres
POSTGRES_PASSWORD=ProdDB_2026_Strong_Pass_9527
POSTGRES_DB=duty_system
DATABASE_URL=postgresql://postgres:ProdDB_2026_Strong_Pass_9527@postgres:5432/duty_system
JWT_SECRET=<YOUR_JWT_SECRET>
PORT=3000
MAIL_USER=<YOUR_EMAIL>
MAIL_PASS=<YOUR_EMAIL_PASSWORD>
DB_SEED=true
```

**注意事项**：
- 密码不要包含 `@`、`:`、`/` 等特殊符号（会导致 URL 解析错误）
- 每个变量必须单独一行
- 邮箱授权码已更新为新生成的

### .gitignore

```bash
# 环境变量文件
.env
.env.local
.env.production
.env.*.local

# 依赖目录
node_modules/
backend/node_modules/
frontend/node_modules/

# 构建输出
dist/
build/
backend/dist/
frontend/dist/

# 日志文件
*.log

# 操作系统文件
.DS_Store

# IDE 配置
.vscode/
.idea/

# 数据库文件
*.sql
```

---

**部署开始时间**：2026年1月22日 15:30
**部署完成时间**：2026年1月23日 00:45
**文档整理人**：Claude Code Assistant
**状态**：✅ 部署成功，所有功能正常

---

## 更新日志

- **2026-01-22 15:30**：开始购买阿里云 ECS 服务器
- **2026-01-22 15:45**：完成服务器购买（99元/年，Ubuntu 24.04）
- **2026-01-22 16:00**：连接服务器成功（FinalShell）
- **2026-01-22 16:15**：完成系统更新和 Docker 安装
- **2026-01-22 16:30**：配置 Docker 镜像加速（阿里云）
- **2026-01-22 16:45**：配置安全组开放端口（22、80、443）
- **2026-01-22 17:00**：处理 Git 敏感文件泄露问题
  - 创建 `.gitignore`
  - 从 Git 中删除 `.env` 文件
  - 更新 QQ 邮箱授权码
- **2026-01-22 17:15**：将 GitHub 仓库改为公开
- **2026-01-22 17:30**：克隆代码到服务器
- **2026-01-22 17:45**：配置生产环境变量
  - 遇到环境变量格式问题（多个变量在同一行）
  - 修复为每行一个变量
- **2026-01-22 18:00**：首次构建启动
  - 遇到 npm 镜像源问题（卡住 28 分钟）
  - 配置淘宝 npm 镜像源
- **2026-01-22 18:30**：解决 Dockerfile 依赖问题
  - 修改 `libssl3` 为 `ca-certificates`
  - 添加 npm 镜像源配置
- **2026-01-22 18:45**：构建完成，启动服务
  - 遇到数据库连接字符串解析错误（密码包含 @ 符号）
  - 修改密码为不含特殊符号
- **2026-01-22 19:00**：解决数据库认证问题
  - 删除旧的数据库 volume
  - 重新初始化数据库
- **2026-01-22 19:10**：遇到后端模块缺失问题
  - 后端镜像缺少 `dist` 目录
  - 重新构建镜像
- **2026-01-22 19:20**：解决 Debian 源无法访问问题
  - 配置阿里云 Debian 镜像源
  - 重新构建成功
- **2026-01-22 19:45**：后端启动成功，前端访问正常
  - 登录功能测试通过
  - 值班表查询正常
- **2026-01-22 20:00**：发现 CRUD 操作报错问题
  - 修改员工、调整顺序、修改密码全部报 500 错误
  - 后端日志显示 `id: undefined`
- **2026-01-23 00:30**：定位并修复 JWT 认证和类型错误
  - 修复 `req.user.userId` → `req.user.id`
  - 移除 `ParseIntPipe`，统一使用 string 类型
  - 修复所有 service 方法的参数类型
  - 推送代码并重新部署
- **2026-01-23 00:45**：所有功能测试通过 ✅
  - 登录 ✅
  - 查看员工列表 ✅
  - 新增员工 ✅
  - 修改员工信息 ✅
  - 调整员工顺序 ✅
  - 修改密码 ✅
  - 值班表查询 ✅

---

## 部署过程总结

### 成功经验

✅ **镜像源配置至关重要**：
- Docker Hub 镜像加速
- npm/pnpm 淘宝镜像
- Debian apt 阿里云镜像

✅ **环境变量注意事项**：
- 每个变量单独一行
- 密码避免特殊字符（@、:、/）
- 修改密码后需要删除数据库 volume

✅ **问题排查流程**：
1. 查看服务状态：`docker compose ps`
2. 查看日志：`docker compose logs [service]`
3. 检查环境变量：`cat .env`
4. 重新构建：`docker compose build --no-cache`

✅ **测试清单**：
- 登录/登出
- 查看员工列表
- 新增员工
- 修改员工信息
- 删除员工
- 调整员工顺序
- 修改密码
- 查看值班表
- 生成值班表
- 发送值班通知

### 踩过的坑

❌ **密码特殊字符**：
- `@` 符号导致 URL 解析错误
- 改用下划线和数字组合

❌ **npm 镜像源**：
- 国外源超时 28 分钟
- 配置国内源后 2-3 分钟搞定

❌ **数据库 volume 持久化**：
- 修改密码后需要删除旧 volume
- 否则密码不匹配

❌ **Debian 软件源**：
- 官方源无法访问
- 需要配置国内镜像

❌ **TypeScript 类型与数据库不一致**：
- UUID 在数据库中是字符串，不是数字
- NestJS 的 `ParseIntPipe` 会将 UUID 转成整数导致错误
- 本地测试不完整，只测了登录没测 CRUD

❌ **Docker 构建缓存使用**：
- 只修改代码时不需要 `--no-cache`，会浪费大量时间
- 修改 Dockerfile、package.json、.env 时才需要 `--no-cache`
- 合理使用缓存可以将构建时间从 2-3 分钟降到 30-60 秒

### 时间消耗分析

| 阶段 | 计划时间 | 实际时间 | 主要耗时原因 |
|------|---------|---------|-------------|
| 购买配置服务器 | 10分钟 | 15分钟 | 学习阿里云界面 |
| 安装 Docker | 5分钟 | 10分钟 | 配置镜像加速 |
| 代码准备 | 15分钟 | 45分钟 | Git 敏感文件处理 |
| 首次构建 | 10分钟 | 90分钟 | npm 源问题卡住 28 分钟，Dockerfile 调整 |
| 调试环境问题 | 10分钟 | 90分钟 | 密码、volume、Dockerfile、数据库初始化 |
| 调试业务 bug | - | 90分钟 | JWT 认证、类型错误，本地测试不完整 |
| **总计** | **50分钟** | **约5.5小时** | 镜像源、配置、代码 bug 等多个问题 |

---

**已完成任务**：
1. ✅ 验证后端服务状态变为 `Up`
2. ✅ 测试网站登录功能
3. ✅ 验证数据库种子数据
4. ✅ 修复业务 bug（JWT 认证、类型错误）
5. ✅ 测试所有 CRUD 功能
6. ✅ 更新部署文档

**下一步**（可选）：
1. 🚀 配置 GitHub Actions 自动部署
2. 🔒 配置域名和 HTTPS
3. 📊 配置监控和日志收集
4. 🔄 设置定时备份
